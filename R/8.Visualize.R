## Figures associated with Shuman et al. publication in prep

## Author: AM Willson

rm(list = ls())

library(corrplot)
library(cowplot)
library(RColorBrewer)
library(dplyr)
library(tibble)
library(ggplot2)
library(tidyr)
library(gridGraphics)
library(patchwork)

# Load data for given model
# Should load the "combined.RData" file in the
# subfolder of the "out" directory corresponding to the
# model of interest
load('out/All_taxa~all_cov_NOASPECT/combined.RData')

## All figures are produced for the "no aspect" simulations but  could
## easily be modified to include aspect

type <- 'all' # reduced or all

## Correlations between taxa and drivers

# Number of columns we're working with
cols <- ncol(bFacGibbs)

# Format for distributions
if(type == 'reduced'){
  bFacGibbs_long <- bFacGibbs |>
    dplyr::select(-c(chain, iter)) |>
    tidyr::pivot_longer(Prairie_Slope:Forest_FloodplainYes,
                 names_to = 'var', values_to = 'val') |>
    dplyr::mutate(taxon = sub(pattern = '_.*', replacement = '', x = var),
           covariate = sub(pattern = '.*_', replacement = '', x = var)) |>
    dplyr::filter(covariate != 'FloodplainNo') |>
    dplyr::filter(covariate != 'HydricNo')
}
if(type == 'all'){
  bFacGibbs_long <- bFacGibbs |>
    dplyr::select(-c(chain, iter)) |>
    tidyr::pivot_longer(No.tree_Slope:Other.hardwood_FloodplainYes,
                 names_to = 'var', values_to = 'val') |>
    dplyr::mutate(taxon = sub(pattern = '_.*', replacement = '', x = var),
           covariate = sub(pattern = '.*_', replacement = '', x = var)) |>
    dplyr::filter(covariate != 'FloodplainNo') |>
    dplyr::filter(covariate != 'HydricNo')
}

# Remove unnecessary columns and generate summary statistics
bFacGibbs_corr <- bFacGibbs |>
  dplyr::select(-c(chain, iter))
corr_mean <- apply(bFacGibbs_corr, 2, mean, na.rm = T)
corr_sd <- apply(bFacGibbs_corr, 2, stats::sd, na.rm = T)
corr_lower <- apply(bFacGibbs_corr, 2, stats::quantile, probs = 0.025, na.rm = T)
corr_upper <- apply(bFacGibbs_corr, 2, stats::quantile, probs = 0.975, na.rm = T)

# Formatting our summary statistics
corr <- rbind(corr_mean, corr_sd, corr_lower, corr_upper)
rownames(corr) <- c('mean', 'sd', 'lower', 'upper')
corr <- t(corr)
corr <- as.data.frame(corr)
corr <- corr |>
  tibble::rownames_to_column(var = 'beta') |>
  dplyr::mutate(taxon = sub('_.*', '', beta),
         covariate = sub('.*_', '', beta))

# Specify color palette
if(type == 'all'){
  pal <- c('#bb5566',
           '#ddaa34', '#ecd08f',
           '#002a53', '#004488', '#4c7cac', '#8aa9c8', '#c2d2e2', '#dee7f0',
           '#005f5f', '#008b8b', '#38a5a5', '#63b9b9', '#8ecdcd', '#c1e4e4')
}
if(type == 'reduced'){
  pal <- c('#bb5566', '#ddaa34', '#002a53')
}

# Plot with free y axis
if(type == 'all'){
  for_plotting <- corr |>
    dplyr::filter(covariate != 'HydricNo') |>
    dplyr::filter(covariate != 'FloodplainNo') |>
    dplyr::mutate(taxon = dplyr::if_else(taxon == 'Black.gum.sweet.gum', 'Black gum/sweet gum', taxon),
           taxon = dplyr::if_else(taxon == 'No.tree', 'No tree', taxon),
           taxon = dplyr::if_else(taxon == 'Other.conifer', 'Other conifer', taxon),
           taxon = dplyr::if_else(taxon == 'Other.hardwood', 'Other hardwood', taxon),
           taxon = dplyr::if_else(taxon == 'Poplar.tulip.poplar', 'Poplar/tulip poplar', taxon)) |>
    dplyr::rename(Taxon = taxon)
  
  my_labeller <- ggplot2::as_labeller(x = c(Slope = 'Slope', CAC = 'CaCO[3]',
                                   CEC = "`Cation exchange capacity`",
                                   CLA = '`Soil % clay`', SAN = '`Soil % sand`',
                                   WAT = '`Available water content`',
                                   mean.SWI = '`Saga Wetness Index`',
                                   totalPPT = 'Precipitation',
                                   MeanTEMP = 'Temperature',
                                   HydricYes = '`Hydric soil`',
                                   FloodplainYes = 'Floodplain'), default = ggplot2::label_parsed)
  
  bFacGibbs_long |>
    dplyr::mutate(taxon = dplyr::if_else(taxon == 'Black.gum.sweet.gum', 'Black gum/sweet gum', taxon),
                  taxon = dplyr::if_else(taxon == 'No.tree', 'No tree', taxon),
                  taxon = dplyr::if_else(taxon == 'Other.conifer', 'Other conifer', taxon),
                  taxon = dplyr::if_else(taxon == 'Other.hardwood', 'Other hardwood', taxon),
                  taxon = dplyr::if_else(taxon == 'Poplar.tulip.poplar', 'Poplar/tulip poplar', taxon)) |>
    dplyr::rename(Taxon = taxon) |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = Taxon, y = val, color = Taxon, fill = Taxon), linewidth = 1.1, alpha = 0.5) +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')),
               labeller = my_labeller, scales = 'free_y',
               nrow = 4, ncol = 3) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood', 'Beech',
                                'Black gum/sweet gum',
                                'Dogwood', 'Elm',
                                'Ironwood', 'Maple', 'Other conifer',
                                'Other hardwood', 'Poplar/tulip poplar',
                                'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood', 'Beech',
                                  'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple', 'Other conifer',
                                  'Other hardwood', 'Poplar/tulip poplar',
                                  'Walnut'),
                       values = pal) +
    ggplot2::scale_fill_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood', 'Beech',
                                  'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple', 'Other conifer',
                                  'Other hardwood', 'Poplar/tulip poplar',
                                  'Walnut'),
                      values = pal) +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.title = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 12))
  
  for_plotting |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = Taxon, ymin = lower, lower = mean - sd, 
                     middle = mean, upper = mean + sd, ymax = upper, 
                     color = Taxon), stat = 'identity') +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')), 
               labeller = my_labeller, scales = 'free_y',
               nrow = 4, ncol = 3) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood', 'Beech',
                                'Black gum/sweet gum',
                                'Dogwood', 'Elm',
                                'Ironwood', 'Maple', 'Other conifer',
                                'Other hardwood', 'Poplar/tulip poplar',
                                'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood',
                                  'Beech', 'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple',
                                  'Other conifer', 'Other hardwood',
                                  'Poplar/tulip poplar', 'Walnut'),
                       values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text.y = ggplot2::element_text(size = 12))
}
if(type == 'reduced'){
  for_plotting <- corr |>
    dplyr::filter(covariate != 'HydricNo') |>
    dplyr::filter(covariate != 'FloodplainNo') |>
    dplyr::rename(Ecosystem = taxon)
  
  my_labeller <- ggplot2::as_labeller(x = c(Slope = 'Slope', 'CAC' = 'CaCO[3]',
                                   CEC = '`Cation exchange capacity`',
                                   CLA = '`Soil % clay`', SAN = '`Soil % sand`',
                                   WAT = '`Available water content`',
                                   totalPPT = 'Precipitation',
                                   MeanTEMP = 'Temperature',
                                   HydricYes = '`Hydric soil`',
                                   mean.SWI = '`Saga Wetness Index`',
                                   FloodplainYes = 'Floodplain'), default = ggplot2::label_parsed)
  
  bFacGibbs_long |>
    dplyr::rename(Ecosystem = taxon) |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = Ecosystem, y = val, color = Ecosystem, fill = Ecosystem), alpha = 0.5, linewidth = 1.1) +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')),
               labeller = my_labeller, scales = 'free_y',
               nrow = 4, ncol = 3) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('Prairie', 'Savanna', 'Forest')) +
    ggplot2::scale_color_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                       values = pal) +
    ggplot2::scale_fill_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                                values = pal) +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.text = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text.y = ggplot2::element_text(size = 12))
  
  for_plotting |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = Ecosystem, ymin = lower, lower = mean - sd,
                     middle = mean, upper = mean + sd, ymax = upper,
                     color = Ecosystem), stat = 'identity') +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT', 
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')),
               labeller = my_labeller, scales = 'free_y',
               nrow = 3, ncol = 4) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('Prairie', 'Savanna', 'Forest')) +
    ggplot2::scale_color_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                       values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text.y = ggplot2::element_text(size = 12), 
          legend.position = "inside", 
          legend.position.inside = c(0.85, 0.125))
}


# Plot with fixed y axis
if(type == 'all'){
  bFacGibbs_long |>
    dplyr::rename(Taxon = taxon) |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = Taxon, y = val, color = Taxon, fill = Taxon), alpha = 0.5, linewidth = 1.1) +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')),
               labeller = my_labeller, scales = 'fixed',
               nrow = 4, ncol = 3) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimates') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood', 'Beech',
                                'Black gum/sweet gum',
                                'Dogwood', 'Elm',
                                'Ironwood', 'Maple', 'Other conifer',
                                'Other hardwood', 'Poplar/tulip poplar',
                                'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood', 'Beech',
                                  'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple', 'Other conifer',
                                  'Other hardwood', 'Poplar/tulip poplar',
                                  'Walnut'),
                       values = pal) +
    ggplot2::scale_fill_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood', 'Beech',
                                  'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple', 'Other conifer',
                                  'Other hardwood', 'Poplar/tulip poplar',
                                  'Walnut'),
                      values = pal) +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text.y = ggplot2::element_text(size = 12))
  
  for_plotting |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = Taxon, ymin = lower, lower = mean - sd,
                     middle = mean, upper = mean + sd, ymax = upper,
                     color = Taxon), stat = 'identity') +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')), labeller = my_labeller, scales = 'fixed') +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood',
                                'Beech', 'Black gum/sweet gum',
                                'Dogwood', 'Elm', 'Ironwood',
                                'Maple', 'Other conifer',
                                'Other hardwood',
                                'Poplar/tulip poplar', 'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood',
                                  'Beech', 'Black gum/sweet gum',
                                  'Dogwood', 'Elm', 'Ironwood',
                                  'Maple', 'Other conifer',
                                  'Other hardwood',
                                  'Poplar/tulip poplar', 'Walnut'),
                       values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text = ggplot2::element_text(size = 12))
}

if(type == 'reduced'){
  bFacGibbs_long |>
    dplyr::rename(Ecosystem = taxon) |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = Ecosystem, y = val, color = Ecosystem, fill = Ecosystem), linewidth = 1.1, alpha = 0.5) +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')),
               labeller = my_labeller,
               scales=  'fixed') +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('Prairie', 'Savanna', 'Forest')) +
    ggplot2::scale_color_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                       values = pal) +
    ggplot2::scale_fill_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                        values = pal) +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text = ggplot2::element_text(size = 12))
  
  for_plotting |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = Ecosystem, ymin = lower, lower = mean - sd,
                 middle = mean, upper = mean + sd, ymax = upper,
                 color = Ecosystem), stat = 'identity') +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CAC', 'CEC', 'CLA', 'SAN', 'WAT', 'HydricYes',
                                             'mean.SWI', 'Slope', 'FloodplainYes')), 
               labeller = my_labeller,
               scales = 'fixed') +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('Prairie', 'Savanna', 'Forest')) +
    ggplot2::scale_color_manual(limits = c('Prairie', 'Savanna', 'Forest'),
                       values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text = ggplot2::element_text(size = 12),
          legend.position = "inside", 
          legend.position.inside = c(0.85, 0.125))
}

#Plot with fewer covariates for main text Figure 3 (free y axis, if type = all only)
if(type == 'all'){
  rem <- c('CAC', 'SAN', 'WAT', 'mean.SWI', 'Slope')
  bFacGibbs_long2 <- dplyr::filter(bFacGibbs_long, !covariate %in% rem)
  for_plotting <- corr |>
    dplyr::filter(covariate != 'HydricNo') |>
    dplyr::filter(covariate != 'FloodplainNo') |>
    dplyr::filter(covariate != 'CAC') |>
    dplyr::filter(covariate != 'SAN') |>
    dplyr::filter(covariate != 'WAT') |>
    dplyr::filter(covariate != 'mean.SWI') |>
    dplyr::filter(covariate != 'Slope') |>
    dplyr::mutate(taxon = dplyr::if_else(taxon == 'Black.gum.sweet.gum', 'Black gum/sweet gum', taxon),
           taxon = dplyr::if_else(taxon == 'No.tree', 'No tree', taxon),
           taxon = dplyr::if_else(taxon == 'Other.conifer', 'Other conifer', taxon),
           taxon = dplyr::if_else(taxon == 'Other.hardwood', 'Other hardwood', taxon),
           taxon = dplyr::if_else(taxon == 'Poplar.tulip.poplar', 'Poplar/tulip poplar', taxon)) |>
    dplyr::rename(Taxon = taxon)
  my_labeller <- as_labeller(x = c(
                                   CEC = '`Cation exchange capacity`',
                                   CLA = '`Soil % clay`', SAN = '`Soil % sand`',
                                   totalPPT = 'Precipitation',
                                   MeanTEMP = 'Temperature',
                                   HydricYes = '`Hydric soil`',
                                   FloodplainYes = 'Floodplain'), default = label_parsed)
  bFacGibbs_long2 |>
    dplyr::rename(Taxon = taxon) |>
    dplyr::mutate(Taxon = dplyr::if_else(Taxon == 'Black.gum.sweet.gum', 'Black gum/sweet gum', Taxon),
           Taxon = dplyr::if_else(Taxon == 'No.tree', 'No tree', Taxon),
           Taxon = dplyr::if_else(Taxon == 'Other.conifer', 'Other conifer', Taxon),
           Taxon = dplyr::if_else(Taxon == 'Other.hardwood', 'Other hardwood', Taxon),
           Taxon = dplyr::if_else(Taxon == 'Poplar.tulip.poplar', 'Poplar/tulip poplar', Taxon)) |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = Taxon, y = val, color = Taxon, fill = Taxon), linewidth = 1.1, alpha = 0.5) +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('totalPPT','MeanTEMP', 
                                             'CEC', 'FloodplainYes', 'CLA', 'HydricYes')),
               labeller = my_labeller, scales = 'free',
               nrow = 3, ncol = 2) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimates') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood', 'Beech',
                                'Black gum/sweet gum',
                                'Dogwood', 'Elm',
                                'Ironwood', 'Maple', 'Other conifer',
                                'Other hardwood', 'Poplar/tulip poplar',
                                'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood', 'Beech',
                                  'Black gum/sweet gum',
                                  'Dogwood', 'Elm',
                                  'Ironwood', 'Maple', 'Other conifer',
                                  'Other hardwood', 'Poplar/tulip poplar',
                                  'Walnut'),
                       values = pal) +
    ggplot2::scale_fill_manual(limits = c('No tree',
                                           'Oak', 'Hickory',
                                           'Ash', 'Basswood', 'Beech',
                                           'Black gum/sweet gum',
                                           'Dogwood', 'Elm',
                                           'Ironwood', 'Maple', 'Other conifer',
                                           'Other hardwood', 'Poplar/tulip poplar',
                                           'Walnut'),
                                values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text.y = ggplot2::element_text(size = 12))
  
  for_plotting |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = Taxon, ymin = lower, lower = mean - sd,
                     middle = mean, upper = mean + sd, ymax = upper,
                     color = Taxon), stat = 'identity') +
    ggplot2::geom_hline(ggplot2::aes(yintercept = 0), color = 'darkgrey', linetype = 'dashed') +
    ggplot2::facet_wrap(~factor(covariate, levels = c('MeanTEMP', 'totalPPT',
                                             'CEC', 'FloodplainYes', 'CLA', 'HydricYes')), labeller = my_labeller, scales = 'free_y', nrow = 3, ncol = 2) +
    ggplot2::xlab('') + ggplot2::ylab('Coefficient estimate') +
    ggplot2::scale_x_discrete(limits = c('No tree',
                                'Oak', 'Hickory',
                                'Ash', 'Basswood',
                                'Beech', 'Black gum/sweet gum',
                                'Dogwood', 'Elm', 'Ironwood',
                                'Maple', 'Other conifer',
                                'Other hardwood',
                                'Poplar/tulip poplar', 'Walnut')) +
    ggplot2::scale_color_manual(limits = c('No tree',
                                  'Oak', 'Hickory',
                                  'Ash', 'Basswood',
                                  'Beech', 'Black gum/sweet gum',
                                  'Dogwood', 'Elm', 'Ironwood',
                                  'Maple', 'Other conifer',
                                  'Other hardwood',
                                  'Poplar/tulip poplar', 'Walnut'),
                       values = pal) +
    cowplot::theme_minimal_grid() +
    ggplot2::theme(axis.text.x = ggplot2::element_blank(),
          strip.text = ggplot2::element_text(size = 14, face = 'bold'),
          legend.title = ggplot2::element_text(size = 14),
          axis.title = ggplot2::element_text(size = 14),
          legend.text = ggplot2::element_text(size = 12),
          axis.text = ggplot2::element_text(size = 12))
}



# Do some cleaning of the sensitivity (fSensGibbs)
fSensGibbs_sum <- fSensGibbs |>
  dplyr::select(-c(chain, iter))
sens_mean <- apply(fSensGibbs_sum, 2, mean, na.rm = T)
sens_sd <- apply(fSensGibbs_sum, 2, stats::sd, na.rm = T)
sens_lower <- apply(fSensGibbs_sum, 2, stats::quantile, probs = 0.025, na.rm = T)
sens_upper <- apply(fSensGibbs_sum, 2, stats::quantile, probs = 0.975, na.rm = T)

sens <- rbind(sens_mean, sens_sd, sens_lower, sens_upper)
rownames(sens) <- c('mean', 'sd', 'lower', 'upper')
sens <- t(sens)
sens <- as.data.frame(sens)
sens <- sens |>
  tibble::rownames_to_column(var = 'covar')

# Figure 2 (includes both boxplot and violin plot options, violin plot is used in the manuscript)
if(type == 'all'){
  # Plot sensitivity
  for_plotting2 <- sens |> 
    dplyr::filter(covar != 'HydricNo') |>
    dplyr::filter(covar != 'FloodplainNo')
  
  for_plotting2 |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = reorder(covar, mean, decreasing = F), 
                     ymin = lower, lower = mean - sd, middle = mean, upper = mean + sd, ymax = upper, 
                     color = reorder(covar, mean, decreasing = T)), stat = 'identity', show.legend = F) +
    ggplot2::coord_flip() +
    ggplot2::xlab('') + ggplot2::ylab(expression(paste('Sensitivity (', hat(F) ,')'))) +
    ggplot2::theme_minimal() +
    ggplot2::scale_color_manual(values = c('#88ccee', # temperature - climate
                                  '#88ccee', # precipitation - climate
                                  '#999932', # cation exchange capacity - soil
                                  '#999932', # floodplain - topography
                                  '#999932', # soil % clay - soil
                                  '#999932', # hydric soil - soil
                                  '#999932', # CaCO3 - soil
                                  '#999932', # available water content - soil
                                  '#999932', # soil % sand - soil
                                  '#aa4499', # saga wetness index - topography
                                  '#aa4499' # slope - topography
    ), name = '') +
    ggplot2::scale_x_discrete(labels = c('totalPPT' = 'Precipitation', 'MeanTEMP' = 'Temperature',
                                'CEC' = 'Cation exchange capacity', 'CLA' = 'Soil % clay',
                                'FloodplainYes' = 'Floodplain', 'HydricYes' = 'Hydric soil',
                                'CAC' = expression(paste('CaC',O[3])), 'WAT' = 'Available water content',
                                'SAN' = 'Soil % sand', 'mean.SWI' = 'SAGA Wetness Index', 'Slope' = 'Slope')) +
    ggplot2::theme(axis.title = ggplot2::element_text(size = 14),
          axis.text = ggplot2::element_text(size = 12))
  
  fSensGibbs |>
    dplyr::select(-c(HydricNo, FloodplainNo, chain, iter)) |>
    tidyr::pivot_longer(Slope:FloodplainYes, names_to = 'covariate', values_to = 'val') |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(ggplot2::aes(x = factor(covariate, levels = c('Slope', 'mean.SWI', 'SAN',
                                                     'WAT', 'CAC', 'HydricYes',
                                                     'FloodplainYes', 'CLA', 'CEC',
                                                     'MeanTEMP', 'totalPPT')),
                    y = val, color = covariate, fill = covariate), show.legend = F, alpha = 0.5, linewidth = 1.1) +
    ggplot2::coord_flip() +
    ggplot2::xlab('') + ggplot2::ylab(expression(paste('Sensitivity (',hat(F),')'))) +
    ggplot2::theme_minimal() +
    ggplot2::scale_color_manual(values = c('#999932', #cac03 - soil
                                  '#999932', # cation exchange capacity - soil
                                  '#999932', # soil % clay - soil
                                  '#999932', # floodplain - topography
                                  '#999932', # hydric soil - soil
                                  '#aa4499', # saga wetness index - topography
                                  '#88ccee', # temperature - climate
                                  '#999932', # soil % sand - soil
                                  '#aa4499', # slope -topography
                                  '#88ccee', # precipitation - climate
                                  '#999932' # available water content - soil
                                  ), name = '') +
    ggplot2::scale_fill_manual(values = c('#999932', #cac03 - soil
                                           '#999932', # cation exchange capacity - soil
                                           '#999932', # soil % clay - soil
                                           '#999932', # floodplain - topography
                                           '#999932', # hydric soil - soil
                                           '#aa4499', # saga wetness index - topography
                                           '#88ccee', # temperature - climate
                                           '#999932', # soil % sand - soil
                                           '#aa4499', # slope -topography
                                           '#88ccee', # precipitation - climate
                                           '#999932' # available water content - soil
                                            ), name = '') +
    ggplot2::scale_x_discrete(labels = c('totalPPT' = 'Precipitation', 'MeanTEMP' = 'Temperature',
                                'CEC' = 'Cation exchange capacity', 'CLA' = 'Soil % clay',
                                'FloodplainYes' = 'Floodplain', 'HydricYes' = 'Hydric soil',
                                'CAC' = expression(paste('CaC',O[3])), 'WAT' = 'Available water content',
                                'SAN' = 'Soil % sand', 'mean.SWI' = 'SAGA Wetness Index', 'Slope' = 'Slope')) +
    ggplot2::theme(axis.title = ggplot2::element_text(size = 14),
          axis.text = ggplot2::element_text(size = 12))
}

# Supplemental Ecosystem-level sensitivity 
if(type == 'reduced'){
  for_plotting2 <- sens |>
    dplyr::filter(covar != 'HydricNo') |>
    dplyr::filter(covar != 'FloodplainNo')
  
  for_plotting2 |>
    ggplot2::ggplot() +
    ggplot2::geom_boxplot(ggplot2::aes(x = reorder(covar, mean, decreasing = F),
                     ymin = lower, lower = mean - sd, middle = mean, upper = mean + sd, ymax = upper,
                     color = reorder(covar, mean, decreasing = T)), stat = 'identity', show.legend = F, lwd = 1) +
    ggplot2::coord_flip() +
    ggplot2::xlab('') + ggplot2::ylab(expression(paste('Sensitivity (',hat(F),')'))) +
    ggplot2::theme_minimal() +
    ggplot2::scale_color_manual(values = c('#88ccee', # precipitation - climate
                                  '#999932', # floodplain - topography
                                  '#88ccee', # temperature - climate
                                  '#999932', # hydric soil - soil
                                  '#999932', # caco3 - soil
                                  '#999932', # soil % clay - soil
                                  '#aa4499', # saga wetness index - topography
                                  '#999932', # available water content - soil
                                  '#999932', # cation exchange capacity - soil
                                  '#999932', # soil % sand - soil
                                  '#aa4499' # slope - topography
                                  ), name = '') +
    ggplot2::scale_x_discrete(labels = c('totalPPT' = 'Precipitation', 'MeanTEMP' = 'Temperature',
                                'CEC' = 'Cation exchange capacity', 'CLA' = 'Soil % clay',
                                'FloodplainYes' = 'Floodplain', 'HydricYes' = 'Hydric soil',
                                'CAC' = expression(paste('CaC',O[3])), 'WAT' = 'Available water content',
                                'SAN' = 'Soil % sand', 'mean.SWI' = 'SAGA Wetness Index', 'Slope' = 'Slope')) +
    ggplot2::theme(axis.title = ggplot2::element_text(size = 14),
          axis.text = ggplot2::element_text(size = 12))
  
  fSensGibbs |>
    dplyr::select(-c(HydricNo, FloodplainNo, chain, iter)) |>
    tidyr::pivot_longer(Slope:FloodplainYes, names_to = 'covariate', values_to = 'val') |>
    ggplot2::ggplot() +
    ggplot2::geom_violin(size = 1.25, ggplot2::aes(x = factor(covariate, levels = c('Slope', 'mean.SWI', 'SAN', 'WAT',
                                                     'CAC',
                                                     'HydricYes', 'CLA',
                                                     'FloodplainYes', 'CEC', 'totalPPT', 'MeanTEMP')),
                    y = val, color = covariate, fill = covariate), show.legend = F, linewidth = 1.1, alpha = 0.5) +
    ggplot2::coord_flip() +
    ggplot2::xlab('') + ggplot2::ylab(expression(paste('Sensitivity (',hat(F),')'))) +
    ggplot2::theme_minimal() +
    ggplot2::scale_color_manual(values = c('#999932', # caco3 - soil
                                  '#999932', # cation exchange capacity - soil
                                  '#999932', # soil % clay - soil
                                  '#999932', # floodplain -topography
                                  '#999932', # hydric soil - soil
                                  '#aa4499', # saga wetness index - topography
                                  '#88ccee', # temperature - climate
                                  '#999932', # soil % sand - soil
                                  '#aa4499', # slope - topography
                                  '#88ccee', # precipitation - climate
                                  '#999932' # available water content - soil
                                  ), name = '') +
    ggplot2::scale_fill_manual(values = c('#999932', # caco3 - soil
                                           '#999932', # cation exchange capacity - soil
                                           '#999932', # soil % clay - soil
                                           '#999932', # floodplain -topography
                                           '#999932', # hydric soil - soil
                                           '#aa4499', # saga wetness index - topography
                                           '#88ccee', # temperature - climate
                                           '#999932', # soil % sand - soil
                                           '#aa4499', # slope - topography
                                           '#88ccee', # precipitation - climate
                                           '#999932' # available water content - soil
                                            ), name = '') +
    ggplot2::scale_x_discrete(labels = c('totalPPT' = expression('Precipitation'), 'MeanTEMP' = expression('Temperature'),
                                'CEC' = expression('Cation exchange capacity'), 'CLA' = expression('Soil % clay'),
                                'FloodplainYes' = expression('Floodplain'), 'HydricYes' = expression('Hydric soil'),
                                'CAC' = expression(paste('CaC',O[3])), 'WAT' = expression('Available water content'),
                                'SAN' = expression('Soil % sand'), 'mean.SWI' = expression('SAGA Wetness Index'), 'Slope' = expression('Slope')))+
    ggplot2::theme(axis.text.y = ggplot2::element_text(size = 20),
      axis.title.x = ggplot2::element_text(size = 22),
          axis.text.x = ggplot2::element_text(size = 20))
    
}

## Correlations between taxa

# Remove unnecessary columns
sgibbs_cor <- sgibbs |>
  dplyr::select(-c(chain, iter))
# Get summary statistics
mean_sgibbs <- apply(sgibbs_cor, 2, mean)
sd_sgibbs <- apply(sgibbs_cor, 2, stats::sd)
lower_sgibbs <- apply(sgibbs_cor, 2, stats::quantile, probs = 0.025)
upper_sgibbs <- apply(sgibbs_cor, 2, stats::quantile, probs = 0.975)

# Need to put into the matrix format
# This gives the index for each entry of the matrix
if(type == 'all'){
  ind <- rbind(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15),
               c(2, 16, 17, 17, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29),
               c(3, 17, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42),
               c(4, 18, 31, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54),
               c(5, 19, 32, 44, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65),
               c(6, 20, 33, 45, 56, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75),
               c(7, 21, 34, 46, 57, 67, 76, 77, 78, 79, 80, 81, 82, 83, 84),
               c(8, 22, 35, 47, 58, 68, 77, 85, 86, 87, 88, 89, 90, 91, 92),
               c(9, 23, 36, 48, 59, 69, 78, 86, 93, 94, 95, 96, 97, 98, 99),
               c(10, 24, 37, 49, 60, 70, 79, 87, 94, 100, 101, 102, 103, 104, 105),
               c(11, 25, 38, 50, 61, 71, 80, 88, 95, 101, 106, 107, 108, 109, 110),
               c(12, 26, 39, 51, 62, 72, 81, 89, 96, 102, 107, 111, 112, 113, 114),
               c(13, 27, 40, 52, 63, 73, 82, 90, 97, 103, 108, 112, 115, 116, 117),
               c(14, 28, 41, 53, 64, 74, 83, 91, 98, 104, 109, 113, 116, 118, 119),
               c(15, 29, 42, 54, 65, 75, 84, 92, 99, 105, 110, 114, 117, 119, 120))
}
if(type == 'reduced'){
  ind <- rbind(c(1, 2, 3),
               c(2, 4, 5),
               c(3, 5, 6))
}

# Now we format the output into a matrix
corr_mat <- mean_sgibbs[ind]
corr_mat <- matrix(corr_mat, nrow = sqrt(length(corr_mat)), ncol = sqrt(length(corr_mat)))
corr_mat <- stats::cov2cor(corr_mat)
if(type == 'all'){
  colnames(corr_mat) <- rownames(corr_mat) <- c('No Tree', 'Oak', 'Elm', 'Hickory', 'Ash', 'Maple', 'Basswood', 'Walnut', 'Ironwood', 'Beech', 'Dogwood', 'Poplar/Tulip Poplar', 'Black Gum/Sweet Gum', 'Other Conifer', 'Other Hardwood')
}
if(type == 'reduced'){
  colnames(corr_mat) <- rownames(corr_mat) <- c('Prairie', 'Savanna', 'Forest')
}

# Specify color palette

pal <- c('#364b9a', '#4a7bb7', '#6ea6cd', '#93cae1', '#cde4ef', 
         '#eaeccc', '#feda8b', '#fdb336', '#f67e4b', '#dd3d2d', '#a50026')

# upper and lower credible intervals
low_mat <- lower_sgibbs[ind]
low_mat <- matrix(low_mat, nrow = nrow(corr_mat), ncol = nrow(corr_mat))
low_mat <- stats::cov2cor(low_mat)
colnames(low_mat) <- rownames(low_mat) <- colnames(corr_mat)

upp_mat <- upper_sgibbs[ind]
upp_mat <- matrix(upp_mat, nrow = nrow(corr_mat), ncol = nrow(corr_mat))
upp_mat <- stats::cov2cor(upp_mat)
colnames(upp_mat) <- rownames(upp_mat) <- colnames(corr_mat)

# Figure 5 
# Plot with uncertainty
if(type == 'all'){
  corrplot::corrplot(corr_mat, lowCI.mat = low_mat, uppCI.mat = upp_mat, plotCI = 'circle',
         diag = F, type = 'upper', col = rev(pal), tl.col = 'black', tl.cex = 0.9, addgrid.col = "white", cl.cex = 1.3, cl.align.text = "l")
  corr_mat_all <- corr_mat
  low_mat_all <- low_mat
  upp_mat_all <- upp_mat
  pall <- wrap_elements(~corrplot::corrplot(corr_mat_all, lowCI.mat = low_mat_all, uppCI.mat = upp_mat_all, plotCI = 'circle', diag = F, type = 'upper', col = rev(pal), tl.col = 'black', tl.cex = 0.9, addgrid.col = "white", cl.cex = 1.3, cl.align.text = "l"))
  save(corr_mat_all, low_mat_all, upp_mat_all, pall, file = "out/all_taxa_corrplot.RData")
}

if(type == 'reduced'){
  corrplot::corrplot(corr_mat, lowCI.mat = low_mat, uppCI.mat = upp_mat, plotCI = 'circle',
           diag = F, type = 'upper', col = rev(pal), tl.col = 'black', tl.cex = 1.4, addgrid.col = "white", cl.cex = 1.4, cl.align.text = "l")
  corr_mat_red <- corr_mat
  low_mat_red <- low_mat
  upp_mat_red <- upp_mat
  preduced <- wrap_elements(~corrplot::corrplot(corr_mat_red, lowCI.mat = low_mat_red, uppCI.mat = upp_mat_red, plotCI = 'circle', diag = F, type = 'upper', col = rev(pal), tl.col = 'black', tl.cex = 1.4, addgrid.col = "white", cl.cex = 1.4, cl.align.text = "l"))
  save(corr_mat_red, low_mat_red, upp_mat_red, preduced, file = "out/reduced_taxa_corrplot.RData")
}

#Save to create a two paneled plot with both all and reduced corrplots for Figure 5
if(type == 'all'){
  load("out/reduced_taxa_corrplot.RData")
}
if(type == 'reduced'){
  load("out/all_taxa_corrplot.RData")
}

#The final plot requires running this script twice, once with the type parameter as "all" and again with the type as "reduced" and saving the output of the corrplot as pall and preduced, respectively
#Load the corrplot object for the "other" type 
pall + preduced
